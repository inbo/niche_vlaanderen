+

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>niche_vlaanderen.niche &mdash; niche_vlaanderen 2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1fc8a8fd"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
 +    <link href="../../_static/css/custom.css" rel="stylesheet" type="text/css">
 +
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            niche_vlaanderen
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Model</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notendop.html">In een notendop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Beschrijving model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../invoer.html">Invoer rasters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validatie.html">Validatie</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overstroming.html">Overstromingsmodule</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running niche</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../codetables.html">Code tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Niche Configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lowlevel.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Credits</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">niche_vlaanderen</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">niche_vlaanderen.niche</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for niche_vlaanderen.niche</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span><span class="p">,</span> <span class="n">URLError</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterstats</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">niche_vlaanderen.vegetation</span> <span class="kn">import</span> <span class="n">Vegetation</span><span class="p">,</span> <span class="n">VegSuitable</span>
<span class="kn">from</span> <span class="nn">niche_vlaanderen.acidity</span> <span class="kn">import</span> <span class="n">Acidity</span>
<span class="kn">from</span> <span class="nn">niche_vlaanderen.nutrient_level</span> <span class="kn">import</span> <span class="n">NutrientLevel</span>
<span class="kn">from</span> <span class="nn">niche_vlaanderen.spatial_context</span> <span class="kn">import</span> <span class="n">SpatialContext</span>
<span class="kn">from</span> <span class="nn">niche_vlaanderen.version</span> <span class="kn">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">__reference_table_version__</span><span class="p">,</span> <span class="n">__reference_table_source__</span><span class="p">,</span> \
    <span class="n">__reference_table_file__</span>
<span class="kn">from</span> <span class="nn">niche_vlaanderen.flooding</span> <span class="kn">import</span> <span class="n">Flooding</span>
<span class="kn">from</span> <span class="nn">niche_vlaanderen.exception</span> <span class="kn">import</span> <span class="n">NicheException</span>
<span class="kn">from</span> <span class="nn">niche_vlaanderen.codetables</span> <span class="kn">import</span> <span class="n">package_resource</span>


<span class="n">_allowed_input</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;soil_code&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlw&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;msw&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mhw&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;seepage&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inundation_acidity&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inundation_nutrient&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nitrogen_atmospheric&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nitrogen_animal&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nitrogen_fertilizer&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;management&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minerality&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rainwater&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inundation_vegetation&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;management_vegetation&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;acidity&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nutrient_level&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span>
<span class="p">}</span>

<span class="n">_minimal_input</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mlw&quot;</span><span class="p">,</span> <span class="s2">&quot;mhw&quot;</span><span class="p">,</span> <span class="s2">&quot;soil_code&quot;</span><span class="p">}</span>

<span class="n">_input_nutrient_level</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;msw&quot;</span><span class="p">,</span>
    <span class="s2">&quot;soil_code&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nitrogen_atmospheric&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nitrogen_fertilizer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nitrogen_animal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;management&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inundation_nutrient&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_input_acidity</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;soil_code&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlw&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minerality&quot;</span><span class="p">,</span>
    <span class="s2">&quot;seepage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rainwater&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inundation_acidity&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_abiotic_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nutrient_level&quot;</span><span class="p">,</span> <span class="s2">&quot;acidity&quot;</span><span class="p">}</span>

<span class="n">_code_tables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ct_acidity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ct_soil_mlw_class&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ct_soil_codes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lnk_acidity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ct_seepage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ct_vegetation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ct_management&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ct_nutrient_level&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ct_mineralisation&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_code_tables_fp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;lnk_potential&quot;</span><span class="p">,</span> <span class="s2">&quot;potential&quot;</span><span class="p">}</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Niche">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche">[docs]</a>
<span class="k">class</span> <span class="nc">Niche</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main Niche model class&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">ct_acidity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ct_soil_mlw_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ct_soil_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">lnk_acidity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ct_seepage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ct_vegetation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ct_management</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ct_nutrient_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ct_mineralisation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new Niche object</span>

<span class="sd">        A niche object can be used to predict vegetation types according to the</span>
<span class="sd">        NICHE Vlaanderen model.</span>

<span class="sd">        The default codetables are used unless other tables are supplied to the</span>
<span class="sd">        constructor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ct_* lnk_*: Pathlib.Path</span>
<span class="sd">            Optionally, paths to codetables can be provided. These will override</span>
<span class="sd">            the standard codetables used by Niche.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;strict_checks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;niche_vlaanderen&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occurrence</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_latest_version</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_code_tables</span><span class="p">:</span>
            <span class="n">ct</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_ct</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get model instance name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set model instance name&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Model object representation&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;# Niche Vlaanderen version: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;# Reference values:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;#     version: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__reference_table_version__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;#     source: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__reference_table_source__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;#     original file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__reference_table_file__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;# Run at: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="c1"># Also add some versions of the major packages we use - easy for</span>
        <span class="c1"># debugging</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;package_versions:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  pandas: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  numpy: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  rasterio: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  gdal: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">__gdal_version__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  python: &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;model_options:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">indent</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;code_tables:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">indent</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">model_properties:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  model_extent: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;input_layers:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">indent</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vegetation_calculated</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;# Model run completed&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;# No model run completed.&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">files_written:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">indent</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_check_latest_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch latest niche version from pypi and compare to currently used version&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://pypi.python.org/pypi/niche_vlaanderen/json&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">json_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="n">releases</span> <span class="o">=</span> <span class="n">json_response</span><span class="p">[</span><span class="s2">&quot;releases&quot;</span><span class="p">]</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">releases</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">parse</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># remove alpha, beta, rc versions</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rc&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>
            <span class="n">indev</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">devstring</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">for</span> <span class="n">devstring</span> <span class="ow">in</span> <span class="n">dev</span><span class="p">)</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versions</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">indev</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

            <span class="n">last</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="n">__version__</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;# Using latest niche_vlaanderen  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">__version__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;# Newer niche_vlaanderen  </span><span class="si">%s</span><span class="s2"> available&quot;</span> <span class="o">%</span> <span class="n">last</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">except</span> <span class="n">URLError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;# Error determinining last upstream version&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_set_ct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update key/value of the code tables&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_code_tables</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_code_tables_fp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Unrecognized codetable </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Cannot find file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Niche.set_input">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.set_input">[docs]</a>
    <span class="k">def</span> <span class="nf">set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a raster or numeric value as input layer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: string</span>
<span class="sd">            The type of grid that you want to assign (eg msw, soil_code, ...).</span>
<span class="sd">            Possible options are listed in</span>
<span class="sd">            https://inbo.github.io/niche_vlaanderen/cli.html#id1</span>
<span class="sd">        value: string | number</span>
<span class="sd">            Path to a file containing the grid. Can be a folder for</span>
<span class="sd">            certain grid types (eg ArcGIS rasters).</span>
<span class="sd">            Can also be a number: in that case a constant value is applied</span>
<span class="sd">            everywhere.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check type is valid value from list</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_allowed_input</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Unrecognized type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vegetation_calculated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Setting new input after model run, &quot;</span> <span class="s2">&quot;clearing results&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_result</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="c1"># Remove any existing values to make sure last value is used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">sc_new</span> <span class="o">=</span> <span class="n">SpatialContext</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">sc_new</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">!=</span> <span class="n">sc_new</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">set_overlap</span><span class="p">(</span><span class="n">sc_new</span><span class="p">)</span>
            <span class="c1"># Remove any existing values to make sure last value is used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Niche.read_config_file">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.read_config_file">[docs]</a>
    <span class="k">def</span> <span class="nf">read_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">overwrite_ct</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the input based on an input file, without running it</span>

<span class="sd">        Configures a model based on a config file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        overwrite_ct: bool (False)</span>
<span class="sd">            Allows the user to override the default codetables (after</span>
<span class="sd">            the class has been initialized).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">config_loaded</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">overwrite_ct</span> <span class="ow">and</span> <span class="s2">&quot;code_tables&quot;</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;code_tables&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;code_tables&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_ct</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># parse input_layers</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;input_layers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># adjust path to be relative to the yaml file</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;input_layers&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;model_options&quot;</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;strict_checks&quot;</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;strict_checks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;strict_checks&quot;</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;overwrite_files&quot;</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;overwrite_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;overwrite_files&quot;</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;output_dir&quot;</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;output_dir&quot;</span>
                <span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;flooding&quot;</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;flooding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">scen_nr</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;flooding&quot;</span><span class="p">]:</span>
                <span class="n">scen</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">scen_nr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;period&quot;</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;flooding&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scen</span><span class="p">)</span></div>


<div class="viewcode-block" id="Niche.run_config_file">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.run_config_file">[docs]</a>
    <span class="k">def</span> <span class="nf">run_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">overwrite_ct</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs Niche using a configuration file</span>

<span class="sd">        This will configure the model, run and output as specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config: string</span>
<span class="sd">            path to a config file</span>
<span class="sd">        overwrite_ct: boolean (False)</span>
<span class="sd">            overwrite codetables using the values specified in</span>
<span class="sd">            the configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">overwrite_ct</span><span class="o">=</span><span class="n">overwrite_ct</span><span class="p">)</span>

        <span class="c1"># Set input values</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">config_loaded</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="c1"># Run + write according to model options</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config_loaded</span><span class="p">[</span><span class="s2">&quot;model_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;overwrite_files&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;overwrite_files&quot;</span><span class="p">]:</span>
            <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;flooding&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">scen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;flooding&quot;</span><span class="p">]:</span>
                <span class="n">ct_nl</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Flooding</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">ct_nl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="n">fp</span> <span class="o">=</span> <span class="n">Flooding</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">scen</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">ct_nl</span><span class="p">)</span>
                <span class="n">depth_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="n">scen</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">])</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
                    <span class="n">depth_file_path</span><span class="o">=</span><span class="n">depth_file</span><span class="p">,</span>
                    <span class="n">period</span><span class="o">=</span><span class="n">scen</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">],</span>
                    <span class="n">frequency</span><span class="o">=</span><span class="n">scen</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">],</span>
                    <span class="n">duration</span><span class="o">=</span><span class="n">scen</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;output_dir&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span> <span class="n">overwrite</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">_files_written</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;output_dir&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_check_all_lower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_array</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="c1"># We ignore comparison problems with np.nan (nodata)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">higher</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">input_array</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">input_array</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">input_array</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">input_array</span><span class="p">[</span><span class="n">b</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">higher</span><span class="p">):</span>
            <span class="c1"># find out which cells have invalid values</span>
            <span class="n">bad_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">higher</span><span class="p">)</span>
            <span class="c1"># convert these cells into the projection system</span>
            <span class="n">bad_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="n">bad_points</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Not all </span><span class="si">{}</span><span class="s2"> values are lower than </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coordinates with invalid values are:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bad_points</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;strict_checks&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span>
                    <span class="s2">&quot;Error: not all </span><span class="si">{}</span><span class="s2"> values are lower than </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="p">)</span>

<div class="viewcode-block" id="Niche.read_rasterio_to_grid">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.read_rasterio_to_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">read_rasterio_to_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">variable_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read grid files using rasterio as Numpy arrays</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name : string | Pathlib.Path</span>
<span class="sd">            Path to the file to be read</span>
<span class="sd">        variable_name : string</span>
<span class="sd">            Name of the variable this grid file represents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get_read_window</span><span class="p">(</span><span class="n">SpatialContext</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

        <span class="c1"># Custom fix for mapping of the old soil_code to the new soil_code</span>
        <span class="k">if</span> <span class="n">variable_name</span> <span class="o">==</span> <span class="s2">&quot;soil_code&quot;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">band</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">):</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">band</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>

        <span class="c1"># Cast inputs to predefined type</span>
        <span class="k">if</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">_allowed_input</span><span class="p">:</span>
            <span class="c1"># Assign fill value for unsigned integers (255) and floats (np.nan)</span>
            <span class="k">if</span> <span class="n">_allowed_input</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
                <span class="c1"># first fill with fill-value compatible to uint8</span>
                <span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_allowed_input</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
                <span class="c1"># convert to float and fill with Nan</span>
                <span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">band</span> <span class="c1"># return numpy array instead of masked array</span></div>


    <span class="k">def</span> <span class="nf">_check_input_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all input files to input_array and applu basic input checks</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        full_model : bool</span>
<span class="sd">            If True, the full niche model is applied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the input array from disk</span>
        <span class="n">inputarray</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_rasterio_to_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="n">variable</span><span class="p">)</span>
            <span class="n">inputarray</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span>

        <span class="c1"># Load in all constant inputvalues</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">height</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="n">inputarray</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span><span class="p">[</span><span class="n">f</span><span class="p">],</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">_allowed_input</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>

        <span class="c1"># check if valid values are used in inputarrays</span>
        <span class="c1"># check for valid datatypes - values will be checked in the low-level</span>
        <span class="c1"># api (eg soil_code present in codetable)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_lower</span><span class="p">(</span><span class="n">inputarray</span><span class="p">,</span> <span class="s2">&quot;mhw&quot;</span><span class="p">,</span> <span class="s2">&quot;mlw&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;msw&quot;</span> <span class="ow">in</span> <span class="n">inputarray</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_lower</span><span class="p">(</span><span class="n">inputarray</span><span class="p">,</span> <span class="s2">&quot;msw&quot;</span><span class="p">,</span> <span class="s2">&quot;mlw&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_lower</span><span class="p">(</span><span class="n">inputarray</span><span class="p">,</span> <span class="s2">&quot;mhw&quot;</span><span class="p">,</span> <span class="s2">&quot;msw&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">full_model</span> <span class="ow">and</span> <span class="s2">&quot;nutrient_level&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputarray</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>  <span class="c1"># ignore NaN comparison errors</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_animal&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_animal&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_fertilizer&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_fertilizer&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_atmospheric&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_atmospheric&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Error: nitrogen values must be &gt;0 and &lt;10000&quot;</span><span class="p">)</span>

        <span class="c1"># if all is successful:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span> <span class="o">=</span> <span class="n">inputarray</span>

<div class="viewcode-block" id="Niche.run">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deviation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the niche model</span>

<span class="sd">        Runs niche Vlaanderen model. Requires that the necessary input values</span>
<span class="sd">        have been added using set_input.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        full_model: bool</span>
<span class="sd">                   Uses the full niche model. The simple model only uses mhw,</span>
<span class="sd">                   mlw and soil_code as input.</span>
<span class="sd">        deviation: bool</span>
<span class="sd">                    Create the maps with the difference between the needed MHW</span>
<span class="sd">                    and MLW and the actual MHW/MLW for a vegetation type.</span>
<span class="sd">        strict_checks: bool</span>
<span class="sd">                By default running a model will fail if impossible combinations</span>
<span class="sd">                of MxW exist somewhere in the input files. By disabling strict</span>
<span class="sd">                checks models can still be run. It will still emit a warning.</span>
<span class="sd">                Note that this is provided to be backwards compatibility and</span>
<span class="sd">                it is recommended to fix the data rather than disabling this.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;full_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;deviation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deviation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;strict_checks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strict_checks</span>

        <span class="k">if</span> <span class="n">full_model</span><span class="p">:</span>
            <span class="n">required_input</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_minimal_input</span><span class="p">)</span>

            <span class="n">given_input</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputvalues</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">if</span> <span class="s2">&quot;nutrient_level&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">given_input</span><span class="p">:</span>
                <span class="n">required_input</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_input_nutrient_level</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;acidity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">given_input</span><span class="p">:</span>
                <span class="n">required_input</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_input_acidity</span><span class="p">)</span>

            <span class="n">missing_keys</span> <span class="o">=</span> <span class="n">required_input</span> <span class="o">-</span> <span class="n">given_input</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Different keys are missing: &quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Error, different obliged keys are missing&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_files</span><span class="p">(</span><span class="n">full_model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">full_model</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;nutrient_level&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
                <span class="n">ct_nl</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">NutrientLevel</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">ct_nl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="n">nl</span> <span class="o">=</span> <span class="n">NutrientLevel</span><span class="p">(</span><span class="o">**</span><span class="n">ct_nl</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">[</span><span class="s2">&quot;nutrient_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
                    <span class="n">soil_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;soil_code&quot;</span><span class="p">],</span>
                    <span class="n">msw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;msw&quot;</span><span class="p">],</span>
                    <span class="n">nitrogen_atmospheric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_atmospheric&quot;</span><span class="p">],</span>
                    <span class="n">nitrogen_animal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_animal&quot;</span><span class="p">],</span>
                    <span class="n">nitrogen_fertilizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;nitrogen_fertilizer&quot;</span><span class="p">],</span>
                    <span class="n">management</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;management&quot;</span><span class="p">],</span>
                    <span class="n">inundation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;inundation_nutrient&quot;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;acidity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
                <span class="n">ct_acidity</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Acidity</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">ct_acidity</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="n">acidity</span> <span class="o">=</span> <span class="n">Acidity</span><span class="p">(</span><span class="o">**</span><span class="n">ct_acidity</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">[</span><span class="s2">&quot;acidity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acidity</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;soil_code&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;mlw&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;inundation_acidity&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;seepage&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;minerality&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;rainwater&quot;</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="n">ct_veg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Vegetation</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">ct_veg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">vegetation</span> <span class="o">=</span> <span class="n">Vegetation</span><span class="p">(</span><span class="o">**</span><span class="n">ct_veg</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;inundation_vegetation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;inundation_vegetation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;management_vegetation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;management_vegetation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">veg_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">soil_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;soil_code&quot;</span><span class="p">],</span>
            <span class="n">mhw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;mhw&quot;</span><span class="p">],</span>
            <span class="n">mlw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;mlw&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">full_model</span><span class="p">:</span>
            <span class="n">veg_arguments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">inundation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;inundation_vegetation&quot;</span><span class="p">],</span>
                <span class="n">management</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;management_vegetation&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;nutrient_level&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
                <span class="n">veg_arguments</span><span class="p">[</span><span class="s2">&quot;nutrient_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;nutrient_level&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">veg_arguments</span><span class="p">[</span><span class="s2">&quot;nutrient_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">[</span><span class="s2">&quot;nutrient_level&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;acidity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
                <span class="n">veg_arguments</span><span class="p">[</span><span class="s2">&quot;acidity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;acidity&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">veg_arguments</span><span class="p">[</span><span class="s2">&quot;acidity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">[</span><span class="s2">&quot;acidity&quot;</span><span class="p">]</span>

        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occurrence</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">vegetation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">full_model</span><span class="o">=</span><span class="n">full_model</span><span class="p">,</span> <span class="o">**</span><span class="n">veg_arguments</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deviation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span> <span class="o">=</span> <span class="n">vegetation</span><span class="o">.</span><span class="n">calculate_deviation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;soil_code&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;mhw&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="s2">&quot;mlw&quot;</span><span class="p">],</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Niche.write">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">overwrite_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detailed_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the model results to a folder</span>

<span class="sd">        Saves the model results to a folder. Files will be written as geotiff.</span>
<span class="sd">        Vegetation files have names V1 ... V28</span>
<span class="sd">        Abiotic files are exported as well (nutrient_level.tif and</span>
<span class="sd">        acidity.tif) if they were not input files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder: string</span>
<span class="sd">            Output folder to which files will be written. Parent directory must</span>
<span class="sd">            already exist.</span>
<span class="sd">        overwrite_files: bool</span>
<span class="sd">            Overwrite files when saving.</span>
<span class="sd">            Note writing will fail if any of the files to be written already</span>
<span class="sd">            exists.</span>
<span class="sd">        detailed_files : bool</span>
<span class="sd">            Save detailed information on factor affecting vegetation possibility</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vegetation_calculated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;A valid run must be done before writing the output.&quot;</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span>

        <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
            <span class="n">nodata</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
            <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;DEFLATE&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;summary.csv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">log.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">V</span><span class="si">{:02d}</span><span class="s2">.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">vi</span><span class="p">)</span>
            <span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}{}</span><span class="s2">.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">vi</span><span class="p">)</span>
            <span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}{}</span><span class="s2">.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">if</span> <span class="n">detailed_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">V</span><span class="si">{:02d}</span><span class="s2">_detail.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">vi</span><span class="p">)</span>
                <span class="n">files</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">_detail&quot;</span> <span class="o">%</span> <span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">overwrite_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Warning: file </span><span class="si">{}</span><span class="s2"> already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="c1"># write a summary file containing the table of the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">])</span>

        <span class="c1"># also save the abiotic grids</span>
        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">detailed_files</span><span class="p">:</span>
            <span class="c1"># write legend file</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">VegSuitable</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">legend</span><span class="p">)})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;legend_detail.csv&quot;</span><span class="p">)</span>
            <span class="c1"># and the actual grids</span>
            <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">_detail&quot;</span> <span class="o">%</span> <span class="n">vi</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">_detail&quot;</span> <span class="o">%</span> <span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># deviation</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=-</span><span class="mi">99999</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">band</span><span class="p">[</span><span class="n">band</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99999</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files_written</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span></div>


<div class="viewcode-block" id="Niche.plot">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixed_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the result or input of a Niche object</span>

<span class="sd">        Creates a plot of an input layer of a Niche object or of the result</span>
<span class="sd">        of a Niche object.</span>

<span class="sd">        Note that depending on your matplotlib environment you may still have</span>
<span class="sd">        to call the matplotlib show method to actually show the plot::</span>

<span class="sd">          &gt;&gt;&gt; myniche.plot(11)</span>
<span class="sd">          &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">          &gt;&gt;&gt; plt.show()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: veg_code (1..28) or input_code</span>
<span class="sd">          key of the vegetation type that should be plotted, eg myniche.plot(7)</span>
<span class="sd">          or key of the input layer you want to plot eg myniche(&quot;mhw&quot;).</span>
<span class="sd">          If deviation was calculated with the model, this can also be plotted,</span>
<span class="sd">          by using `input_code_veg_code` eg `mhw_14`</span>

<span class="sd">        ax: `matplotlib.axes.Axes`_</span>
<span class="sd">          optional axis parameter. Can be specified when you want to plot</span>
<span class="sd">          different plots in one layout</span>

<span class="sd">        fixed_scale: boolean (default: True)</span>
<span class="sd">           Use a fixed scale</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax: `matplotlib.axes.Axes`_</span>
<span class="sd">          Can be used to update the plot (eg change the title).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
            <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not import matplotlib</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;matplotlib required for plotting functions&quot;</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Inform user that data is not available to plot</span>
        <span class="c1"># (key is present, but value is None)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> data is not available to plot.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
            <span class="c1"># if set_input has been done, but no model run yet</span>
            <span class="c1"># in this case we will open the file and fetch the data</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_rasterio_to_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputfiles</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputarray</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abiotic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vegcode2name</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">if</span> <span class="n">fixed_scale</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;mhw&quot;</span><span class="p">,</span> <span class="s2">&quot;mlw&quot;</span><span class="p">,</span> <span class="s2">&quot;msw&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="n">fixed_scale</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Invalid key specified&quot;</span><span class="p">)</span>

        <span class="c1"># Convert uint8 with no-data 255 into Masked array</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">extent</span>
        <span class="n">mpl_extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">mpl_extent</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">title</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;not present&quot;</span><span class="p">,</span> <span class="s2">&quot;present&quot;</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
            <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Niche.plot_detail">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.plot_detail">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">limit_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detailed plot for a vegetation type</span>
<span class="sd">        key: veg_code (1..28)</span>
<span class="sd">          key of the vegetation type that should be plotted</span>
<span class="sd">        limit_legend: boolean</span>
<span class="sd">            limits the legend to the types present in the figure</span>
<span class="sd">        cmap: colormap</span>
<span class="sd">            colormap to use for the maps. Note that 9 combinations of</span>
<span class="sd">            presence/absence are possible, so keep this in mind if changing</span>
<span class="sd">            from the default value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not import matplotlib</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;matplotlib required for plotting functions&quot;</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;invalid key for plot, must be a number of a vegetation type&quot;</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vegcode2name</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># always dtype uint8 with 255 as no-data</span>
        <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">extent</span>
        <span class="n">mpl_extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">legend</span> <span class="o">=</span> <span class="n">VegSuitable</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">legend_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">legend</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="c1"># convert vegetation matrix to legend item matrix</span>
        <span class="n">v_un</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">legend_keys</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">v_un</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">v_un</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">v_un</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">mpl_extent</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">VegSuitable</span><span class="o">.</span><span class="n">possible</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">limit_legend</span><span class="p">:</span>
            <span class="n">present</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">v_un</span><span class="p">[</span><span class="o">~</span><span class="n">v_un</span><span class="o">.</span><span class="n">mask</span><span class="p">])</span>

            <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">](</span><span class="n">i</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="n">legend_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">present</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">](</span><span class="n">i</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">title</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dataframe containing the potential area (ha) per vegetation type&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dataframe containing the potential area (ha) per vegetation type</span>

<span class="sd">        detail: boolean</span>
<span class="sd">            add info why vegetation is present, rather than just present/not present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vegetation_calculated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span>
                <span class="s2">&quot;Error: You must run niche prior to requesting the &quot;</span> <span class="s2">&quot;result table&quot;</span>
            <span class="p">)</span>

        <span class="n">td</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">presence</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;not present&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;present&quot;</span><span class="p">,</span> <span class="mi">255</span><span class="p">:</span> <span class="s2">&quot;no data&quot;</span><span class="p">})</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">:</span>
                <span class="n">vi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="n">rec</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">cell_area</span> <span class="o">/</span> <span class="mi">10000</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">td</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">presence</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">VegSuitable</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">legend</span><span class="p">[</span><span class="n">Vegetation</span><span class="o">.</span><span class="n">nodata</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no data&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span><span class="p">:</span>
                <span class="n">vi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vegetation_detail</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="n">rec</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">cell_area</span> <span class="o">/</span> <span class="mi">10000</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">td</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">legend</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;presence&quot;</span><span class="p">,</span> <span class="s2">&quot;area_ha&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="Niche.zonal_stats">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.Niche.zonal_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">zonal_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">outside</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">vegetation_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upscale</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates zonal statistics using vectors</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vectors : path to a vector source or geo-like python objects</span>
<span class="sd">            you can specify a path to a vector file eg &quot;../test.shp&quot;, or pass</span>
<span class="sd">            geo objects from other python functions.</span>

<span class="sd">            Note that the vector should be in the same coordinate system as the</span>
<span class="sd">            raster.</span>
<span class="sd">        outside : bool (default: True)</span>
<span class="sd">           report values outside shapes as well. The area which is not covered</span>
<span class="sd">           by any shapefile will get shape_id -1.</span>
<span class="sd">        attribute : string(default None):</span>
<span class="sd">            attribute of the vector source that will be exported along in the</span>
<span class="sd">            table.</span>
<span class="sd">        vegetation_types : List | None</span>
<span class="sd">            optional list of vegetation types (as integer number) for which the</span>
<span class="sd">            statistics must be calculated. Calculation will happen for all</span>
<span class="sd">            niche vegetation types by default.</span>
<span class="sd">        upscale : int</span>
<span class="sd">            upscaling factor: decrease the cell size by this factor to increase</span>
<span class="sd">            the resolution</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        table : pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">td</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Ignore the warnings from rasterstats - code must be adjusted</span>
        <span class="c1"># in that package - not in our code.</span>
        <span class="c1"># warnings.simplefilter(action=&quot;ignore&quot;, category=FutureWarning)</span>
        <span class="c1"># warnings.simplefilter(action=&quot;ignore&quot;, category=DeprecationWarning)</span>

        <span class="n">presence</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;not present&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;present&quot;</span><span class="p">,</span> <span class="mi">255</span><span class="p">:</span> <span class="s2">&quot;no data&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">vegetation_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vegetation_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vegetation_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Can not calculate zonal statistics for &quot;</span>
                                 <span class="s2">&quot;empty vegetation list&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vegetation_types: </span><span class="si">{</span><span class="n">vegetation_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;upscaling to </span><span class="si">{</span><span class="n">upscale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">vegetation_types</span><span class="p">):</span>
            <span class="c1"># Note we use -99 as nodata value to make sure the true nodata</span>
            <span class="c1"># value (255) is part of the result table.</span>

            <span class="k">if</span> <span class="n">upscale</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">affine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">transform</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># based on</span>
                <span class="c1"># https://rasterio.readthedocs.io/en/latest/topics/resampling.html</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">upscale</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">upscale</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">affine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="n">td</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rasterstats</span><span class="o">.</span><span class="n">zonal_stats</span><span class="p">(</span>
                <span class="n">vectors</span><span class="o">=</span><span class="n">vectors</span><span class="p">,</span>
                <span class="n">raster</span><span class="o">=</span><span class="n">raster</span><span class="p">,</span>
                <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">,</span>
                <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="n">Vegetation</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span>
                <span class="n">geojson_out</span><span class="o">=</span><span class="n">attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>

        <span class="n">ti</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attribute_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">td</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">shape_i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">td</span><span class="p">[</span><span class="n">vi</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">presence</span><span class="p">:</span>
                    <span class="n">pixels</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">ti</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">vi</span><span class="p">),</span>
                            <span class="n">shape_i</span><span class="p">,</span>
                            <span class="n">presence</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
                            <span class="n">pixels</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">cell_area</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">/</span> <span class="p">(</span><span class="n">upscale</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">attribute_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;shape_id&quot;</span><span class="p">,</span> <span class="s2">&quot;presence&quot;</span><span class="p">,</span> <span class="s2">&quot;area_ha&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">outside</span><span class="p">:</span>
            <span class="c1"># calculate area outside polygons</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;presence&quot;</span><span class="p">])[</span><span class="s2">&quot;area_ha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;presence&quot;</span><span class="p">])[</span><span class="s2">&quot;area_ha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;presence&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;inshape&quot;</span><span class="p">]</span>
            <span class="n">a</span><span class="p">[</span><span class="s2">&quot;area_ha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;inshape&quot;</span><span class="p">]</span>
            <span class="n">a</span><span class="p">[</span><span class="s2">&quot;shape_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;shape_id&quot;</span><span class="p">,</span> <span class="s2">&quot;presence&quot;</span><span class="p">,</span> <span class="s2">&quot;area_ha&quot;</span><span class="p">]]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>
            <span class="n">attribute_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;shape_id&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute_list</span>

        <span class="k">return</span> <span class="n">df</span></div>


    <span class="k">def</span> <span class="nf">_vegcode2name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vegcode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts a vegetation code to a name</span>

<span class="sd">        Uses ct_vegetation columns veg_code and veg_type&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_vegcode2namedict&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;ct_vegetation&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">:</span>
                <span class="n">ct_vegetation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_tables</span><span class="p">[</span><span class="s2">&quot;ct_vegetation&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ct_vegetation</span> <span class="o">=</span> <span class="n">package_resource</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;system_tables&quot;</span><span class="p">],</span> <span class="s2">&quot;niche_vegetation.csv&quot;</span><span class="p">)</span>

            <span class="n">ct_vegetation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ct_vegetation</span><span class="p">)</span>
            <span class="n">subtable</span> <span class="o">=</span> <span class="n">ct_vegetation</span><span class="p">[[</span><span class="s2">&quot;veg_code&quot;</span><span class="p">,</span> <span class="s2">&quot;veg_type&quot;</span><span class="p">]]</span>
            <span class="n">veg_dict</span> <span class="o">=</span> <span class="n">subtable</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;veg_code&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;veg_type&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vegcode2namedict</span> <span class="o">=</span> <span class="n">veg_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vegcode2namedict</span><span class="p">[</span><span class="n">vegcode</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vegetation_calculated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_clear_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clears calculated vegetation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vegetation</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deviation</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pre</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pre</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">pre</span><span class="p">)</span>


<div class="viewcode-block" id="NicheDelta">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.NicheDelta">[docs]</a>
<span class="k">class</span> <span class="nc">NicheDelta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class containing the difference between two niche runs</span>

<span class="sd">    The difference can be visualized using the plot method. It is also</span>
<span class="sd">    possible to derive a table with the area&#39;s according to each group.</span>

<span class="sd">    See the tutorial at: `Comparing Niche classes`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;not present in both models&quot;</span><span class="p">,</span>
        <span class="s2">&quot;present in both models&quot;</span><span class="p">,</span>
        <span class="s2">&quot;only in model 1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;only in model 2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nodata in one model&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;niche_vlaanderen&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n1</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n2</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span>
                <span class="s2">&quot;No extent in Niche object. Please run both models prior to &quot;</span>
                <span class="s2">&quot;calculating a delta.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">n1</span><span class="o">.</span><span class="n">_context</span> <span class="o">!=</span> <span class="n">n2</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span>
                <span class="s2">&quot;Spatial contexts differ, can not make a delta</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Context 1 </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Context 2 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">n1</span><span class="o">.</span><span class="n">_context</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">n2</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span>
                <span class="s2">&quot;No vegetation in Niche object. Please run both models prior &quot;</span>
                <span class="s2">&quot;to calculating a delta.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># the error below should not occur as we check the context, but</span>
        <span class="c1"># better safe than sorry</span>
        <span class="k">if</span> <span class="n">n1</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">n2</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Arrays have different size.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n2</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;Niche vegetation objects have different length.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">n1</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">:</span>
            <span class="n">n1v</span> <span class="o">=</span> <span class="n">n1</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">n2v</span> <span class="o">=</span> <span class="n">n2</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n1v</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[((</span><span class="n">n1v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n2v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">res</span><span class="p">[((</span><span class="n">n1v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n2v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">res</span><span class="p">[((</span><span class="n">n1v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n2v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">res</span><span class="p">[((</span><span class="n">n1v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n2v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">res</span><span class="p">[((</span><span class="n">n1v</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n2v</span> <span class="o">==</span> <span class="mi">255</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">255</span>
            <span class="n">res</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">_vegetation</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n1</span> <span class="o">=</span> <span class="n">n1</span>

<div class="viewcode-block" id="NicheDelta.write">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.NicheDelta.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">overwrite_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes the difference grids to grid files.</span>

<span class="sd">        The differences are coded using these values:</span>

<span class="sd">         * 0: &quot;not present in both models&quot;</span>
<span class="sd">         * 1: &quot;present in both models&quot;</span>
<span class="sd">         * 2: &quot;only in model 1&quot;</span>
<span class="sd">         * 3: &quot;only in model 2&quot;</span>
<span class="sd">         * 4: &quot;nodata in one model&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        folder: path</span>
<span class="sd">            Path to which the output files will be written.</span>
<span class="sd">        overwrite_files: bool</span>
<span class="sd">            Whether files should be overwritten on save.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
            <span class="n">nodata</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
            <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;DEFLATE&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">delta_summary.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">legend_delta.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">:</span>
            <span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">D</span><span class="si">{}</span><span class="s2">.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">vi</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">overwrite_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: file </span><span class="si">{}</span><span class="s2"> already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NicheException</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Also the resulting table is written</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># And a small file containing the legend</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">))</span>
        <span class="n">legend</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="NicheDelta.plot">
<a class="viewcode-back" href="../../lowlevel.html#niche_vlaanderen.NicheDelta.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the difference between two classes</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        key: number</span>
<span class="sd">            The vegetation code (1-28)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
            <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not import matplotlib</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;matplotlib required for plotting functions&quot;</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">extent</span>
        <span class="n">mpl_extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">mpl_extent</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">)),</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n1</span><span class="o">.</span><span class="n">_vegcode2name</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n1</span><span class="o">.</span><span class="n">_vegcode2name</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a summarized dataframe for a NicheDelta object</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        df: `pandas.DataFrame`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">td</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">:</span>
            <span class="n">vi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">td</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)],</span> <span class="n">rec</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">cell_area</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;presence&quot;</span><span class="p">,</span> <span class="s2">&quot;area_ha&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span></div>



<span class="k">def</span> <span class="nf">conductivity2minerality</span><span class="p">(</span><span class="n">conductivity</span><span class="p">,</span> <span class="n">minerality</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a grid with conductivity to a grid of minerality</span>

<span class="sd">    Helper function that converts a grid with conductivity values</span>
<span class="sd">    to a grid of minerality values (where conductivity &gt; 500).</span>

<span class="sd">    Supplied for backwards compatibility with the original niche vlaanderen</span>
<span class="sd">    model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    conductivity: filename</span>
<span class="sd">      Original grid with conductivity values.</span>
<span class="sd">    minerality: filename</span>
<span class="sd">      New grid where minerality values are stored. This will be a geotiff, so</span>
<span class="sd">      extension .tif is recommended.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># we will ignore future warnings from rasterio</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">FutureWarning</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">conductivity</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">band</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span>
            <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;compress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEFLATE&quot;</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">minerality</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017 - 2023, Research Institute for Nature and Forest (INBO).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>